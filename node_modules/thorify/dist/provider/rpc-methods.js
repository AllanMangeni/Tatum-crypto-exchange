'use strict';
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const thor_devkit_1 = require("thor-devkit");
const utils = require("../utils");
const simple_http_1 = require("./simple-http");
const debug = require('debug')('thor:http-provider:rpc');
exports.RPCMethodMap = new Map();
const getRevertReason = (returned) => {
    const ErrorStringMatcher = /^0x08c379a0/i;
    const PanicUint256Matcher = /^0x4e487b71/i;
    try {
        if (ErrorStringMatcher.test(returned)) {
            return thor_devkit_1.abi.decodeParameter('string', returned.replace(ErrorStringMatcher, '0x'));
        }
        if (PanicUint256Matcher.test(returned)) {
            return `Panic(0x${parseInt(thor_devkit_1.abi.decodeParameter('uint256', returned.replace(PanicUint256Matcher, '0x')), 10).toString(16)})`;
        }
        return null;
    }
    catch (_a) {
        return null;
    }
};
const HTTPPostProcessor = function (res) {
    if (res.Code === 0) {
        return Promise.reject(new Error(`[thor-provider] Invalid response, check the host`));
    }
    if (res.Code !== 200) {
        return Promise.reject(new Error(res.Body ? res.Body : ('[thor-provider] Invalid response code from provider: ' + res.Code)));
    }
    return Promise.resolve(res.Body);
};
exports.RPCMethodMap.set('eth_getBlockByNumber', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/blocks/' + utils.fromETHBlockNumber(rpc.params[0]);
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(res);
    });
});
exports.RPCMethodMap.set('eth_getBlockByHash', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/blocks/' + rpc.params[0];
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(res);
    });
});
exports.RPCMethodMap.set('eth_blockNumber', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/blocks/best';
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.number);
    });
});
exports.RPCMethodMap.set('eth_getBalance', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/accounts/' + rpc.params[0] + '?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[1]);
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.balance);
    });
});
exports.RPCMethodMap.set('eth_getEnergy', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/accounts/' + rpc.params[0] + '?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[1]);
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.energy);
    });
});
exports.RPCMethodMap.set('eth_getCode', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/accounts/' + rpc.params[0] + '/code?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[1]);
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.code);
    });
});
exports.RPCMethodMap.set('eth_getStorageAt', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/accounts/' + rpc.params[0] + '/storage/' + utils.leftPadToBytes32(rpc.params[1]) + '?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[2]);
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.value);
    });
});
exports.RPCMethodMap.set('eth_sendRawTransaction', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/transactions';
        const reqBody = {
            raw: rpc.params[0],
        };
        const res = yield simple_http_1.HTTP.post(URL, reqBody, timeout).then(HTTPPostProcessor);
        return rpc.makeResult(!res ? null : res.id);
    });
});
exports.RPCMethodMap.set('eth_getTransactionByHash', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/transactions/' + rpc.params[0];
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        if (!res) {
            return rpc.makeResult(null);
        }
        res.blockNumber = res.meta.blockNumber;
        return rpc.makeResult(res);
    });
});
exports.RPCMethodMap.set('eth_getTransactionReceipt', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/transactions/' + rpc.params[0] + '/receipt';
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        if (!res) {
            return rpc.makeResult(null);
        }
        res.blockNumber = res.meta.blockNumber;
        res.blockHash = res.meta.blockID;
        res.transactionHash = res.meta.txID;
        // For compatible with ethereum's receipt
        if (res.reverted) {
            res.status = '0x0';
        }
        else {
            res.status = '0x1';
        }
        if (res.outputs.length === 1) {
            res.contractAddress = res.outputs[0].contractAddress;
        }
        return rpc.makeResult(res);
    });
});
exports.RPCMethodMap.set('eth_call', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const extraURI = '?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[1]);
        const URL = host + '/accounts/*' + extraURI;
        const reqBody = {
            clauses: [{
                    to: rpc.params[0].to || null,
                    value: rpc.params[0].value || '',
                    data: rpc.params[0].data || '0x',
                }],
            gasPrice: rpc.params[0].gasPrice || undefined,
        };
        if (rpc.params[0].gas) {
            if (typeof rpc.params[0].gas === 'number') {
                reqBody.gas = rpc.params[0].gas;
            }
            else {
                reqBody.gas = parseInt(utils.sanitizeHex(rpc.params[0].gas), 16);
            }
        }
        if (rpc.params[0].from) {
            reqBody.caller = rpc.params[0].from;
        }
        const res = yield simple_http_1.HTTP.post(URL, reqBody, timeout).then(HTTPPostProcessor);
        debug('eth_call returns', res);
        if (!res || res.length === 0) {
            return rpc.makeResult(null);
        }
        else {
            const result = res[0];
            if (result.reverted || result.vmError) {
                if (result.data) {
                    const reason = getRevertReason(result.data);
                    if (reason) {
                        return rpc.makeError('VM reverted: ' + reason);
                    }
                }
                return rpc.makeError('VM executing failed' + (result.vmError ? ': ' + result.vmError : ''));
            }
            else {
                return rpc.makeResult(result.data === '0x' ? '' : result.data);
            }
        }
    });
});
exports.RPCMethodMap.set('eth_estimateGas', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const extraURI = '?revision=' + utils.fromETHBlockNumberOrHash(rpc.params[1]);
        const URL = host + '/accounts/*' + extraURI;
        const reqBody = {
            clauses: [{
                    to: rpc.params[0].to || null,
                    value: rpc.params[0].value || '',
                    data: rpc.params[0].data || '0x',
                }],
            gasPrice: rpc.params[0].gasPrice || undefined,
        };
        if (rpc.params[0].gas) {
            if (typeof rpc.params[0].gas === 'number') {
                reqBody.gas = rpc.params[0].gas;
            }
            else {
                reqBody.gas = parseInt(utils.sanitizeHex(rpc.params[0].gas), 16);
            }
        }
        if (rpc.params[0].from) {
            reqBody.caller = rpc.params[0].from;
        }
        const res = yield simple_http_1.HTTP.post(URL, reqBody, timeout).then(HTTPPostProcessor);
        if (!res || res.length === 0) {
            return rpc.makeResult(null);
        }
        else {
            const result = res[0];
            if (result.reverted || result.vmError) {
                if (result.data) {
                    const reason = getRevertReason(result.data);
                    if (reason) {
                        return rpc.makeError('Gas estimation failed with VM reverted: ' + reason);
                    }
                }
                return rpc.makeError('Gas estimation failed' + (result.vmError ? ': ' + result.vmError : ''));
            }
            else {
                debug('VM gas:', result.gasUsed);
                // ignore the overflow since block gas limit is uint64 and JavaScript's max number is 2^53
                const intrinsicGas = thor_devkit_1.Transaction.intrinsicGas(reqBody.clauses);
                // increase vm gas by 15000 for safe since it's estimated from current block state, final state for the transaction is not determined for now
                return rpc.makeResult(intrinsicGas + (result.gasUsed ? (result.gasUsed + 15000) : 0));
            }
        }
    });
});
exports.RPCMethodMap.set('eth_getLogs', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const reqBody = utils.formatLogQuery(rpc.params[0]);
        const URL = host + '/logs/event';
        const res = yield simple_http_1.HTTP.post(URL, reqBody, timeout).then(HTTPPostProcessor);
        if (!res) {
            return rpc.makeResult(null);
        }
        for (const item of res) {
            item.blockNumber = item.meta.blockNumber;
            item.blockHash = item.meta.blockID;
            item.transactionHash = item.meta.txID;
        }
        return rpc.makeResult(res);
    });
});
exports.RPCMethodMap.set('eth_getBlockRef', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/blocks/best';
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        if (!res || !res.id) {
            return rpc.makeResult(null);
        }
        return rpc.makeResult(res.id.substr(0, 18));
    });
});
exports.RPCMethodMap.set('eth_getChainTag', function (rpc, host, timeout) {
    return __awaiter(this, void 0, void 0, function* () {
        const URL = host + '/blocks/0';
        const res = yield simple_http_1.HTTP.get(URL, timeout).then(HTTPPostProcessor);
        if (!res || !res.id || res.id.length !== 66) {
            return rpc.makeResult(null);
        }
        return rpc.makeResult('0x' + res.id.substr(64, 2));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnBjLW1ldGhvZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcHJvdmlkZXIvcnBjLW1ldGhvZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFBOzs7Ozs7Ozs7OztBQUVaLDZDQUE0QztBQUM1QyxrQ0FBaUM7QUFFakMsK0NBQW9EO0FBQ3BELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO0FBRzNDLFFBQUEsWUFBWSxHQUFHLElBQUksR0FBRyxFQUF1QixDQUFBO0FBRzFELE1BQU0sZUFBZSxHQUFHLENBQUMsUUFBZ0IsRUFBaUIsRUFBRTtJQUN4RCxNQUFNLGtCQUFrQixHQUFHLGNBQWMsQ0FBQTtJQUN6QyxNQUFNLG1CQUFtQixHQUFHLGNBQWMsQ0FBQTtJQUMxQyxJQUFJO1FBQ0EsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUM7WUFDbEMsT0FBTyxpQkFBRyxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFBO1NBQ25GO1FBQ0QsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDcEMsT0FBTyxXQUFXLFFBQVEsQ0FBQyxpQkFBRyxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFBO1NBQzlIO1FBQ0QsT0FBTyxJQUFJLENBQUE7S0FDZDtJQUFDLFdBQU07UUFDSixPQUFPLElBQUksQ0FBQTtLQUNkO0FBQ0wsQ0FBQyxDQUFBO0FBRUQsTUFBTSxpQkFBaUIsR0FBRyxVQUFTLEdBQW1CO0lBQ2xELElBQUksR0FBRyxDQUFDLElBQUks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